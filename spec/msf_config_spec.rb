# -*- coding: utf-8 -*-

require_relative 'spec_helper'

describe 'pentester::msf_config' do
  subject { ChefSpec::SoloRunner.new.converge(described_recipe) }

  it 'creates template[/opt/metasploit-framework/config/database.yml]' do
    config_file = '/opt/metasploit-framework/config/database.yml'
    expect(subject).to create_template(config_file)
      .with(owner: 'root',
            group: 'root',
            source: 'msf/database.yml.erb')

    [/database: msf$/,
     /username: msf$/,
     /password: msf$/,
     /host: localhost$/,
     /port: 5432$/].each do |m|
      expect(subject).to render_file(config_file).with_content(m)
    end
  end

  it 'does not create template[/root/.msf4/config]' do
    expect(subject).to_not create_template('/root/.msf4/config')
      .with(owner: 'root',
            group: 'root',
            source: 'msf/config.erb')
  end

  it 'does not create template[/root/.msf4/msfconsole.rc]' do
    expect(subject).to_not create_template('/root/.msf4/msfconsole.rc')
      .with(owner: 'root',
            group: 'root',
            source: 'msf/msfconsole.rc.erb')
  end

  context 'with user configuration' do
    let(:subject) do
      ChefSpec::SoloRunner.new do |node|
        node.set['pentester']['msf']['config'] = {
          'framework/core' => {
            'PromptChar' => '>>'
          }
        }
        node.set['pentester']['msf']['msfconsole.rc'] = ['load sounds']
      end.converge(described_recipe)
    end

    it 'creates template[/root/.msf4/config]' do
      expect(subject).to create_template('/root/.msf4/config')
        .with(owner: 'root',
              group: 'root',
              source: 'msf/config.erb')
    end

    it 'creates template[/root/.msf4/msfconsole.rc]' do
      expect(subject).to create_template('/root/.msf4/msfconsole.rc')
        .with(owner: 'root',
              group: 'root',
              source: 'msf/msfconsole.rc.erb')
    end
  end
end
