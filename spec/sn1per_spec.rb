# -*- coding: utf-8 -*-

require_relative 'spec_helper'

describe 'pentester::sn1per' do
  subject { ChefSpec::SoloRunner.new.converge(described_recipe) }
  let(:subject) do
    ChefSpec::SoloRunner.new do |node|
      node.set['pentester']['sn1per']['packages'] = %w(host whois etc)
      node.set['pentester']['sn1per']['additional_repos'] = {
        myrepo: {
          url: 'https://github.com/my/repo.git',
          reference: 'mybranch'
        },
        'my-repo' => {
          url: 'https://github.com/me/my-repo.git',
          reference: 'my-branch'
        }
      }
    end.converge(described_recipe)
  end

  it 'sync git[/opt/sn1per]' do
    expect(subject).to sync_git('/opt/Sn1per')
      .with(repository: 'https://github.com/1N3/sn1per',
            reference: 'master')
  end

  %w(host whois etc).each do |pkg|
    it "installs package[#{pkg}]" do
      expect(subject).to install_package(pkg)
    end
  end

  it 'sync git[/opt/Sn1per/myrepo' do
    expect(subject).to sync_git('/opt/Sn1per/myrepo')
      .with(repository: 'https://github.com/my/repo.git',
            reference: 'mybranch')
  end

  it 'sync git[/opt/Sn1per/my-repo' do
    expect(subject).to sync_git('/opt/Sn1per/my-repo')
      .with(repository: 'https://github.com/me/my-repo.git',
            reference: 'my-branch')
  end

  it 'creates directory[/opt/Sn1per/loot]' do
    expect(subject).to create_directory('/opt/Sn1per/loot')
  end

  it 'creates file[/opt/Sn1per/sniper]' do
    expect(subject).to create_file('/opt/Sn1per/sniper')
      .with(mode: '0755')
  end
end
