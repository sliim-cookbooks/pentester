# -*- coding: utf-8 -*-

require_relative 'spec_helper'

describe 'pentester::gitrob_config' do
  let(:subject) do
    ChefSpec::SoloRunner.new(platform: 'debian',
                             version: '8.0') do |node|
      node.override['pentester']['db']['port'] = 1337
    end.converge(described_recipe)
  end

  it 'creates template[/root/.gitrobrc]' do
    config_file = '/root/.gitrobrc'
    expect(subject).to create_template(config_file)
      .with(owner: 'root',
            group: 'root',
            source: 'gitrobrc.erb')

    [%r{^sql_connection_uri: postgres://gitrob:gitrob@localhost:1337/gitrob$},
     /^github_access_tokens:\n- aabbccddeeff00112233445566778899$/].each do |m|
      expect(subject).to render_file(config_file).with_content(m)
    end
  end

  it 'does not create [/root/.gitrobsignatures]' do
    expect(subject).to_not create_file('/root/.gitrobsignatures')
  end

  context 'with custom signatures' do
    let(:subject) do
      ChefSpec::SoloRunner.new(platform: 'debian',
                               version: '8.0') do |node|
        node.override['pentester']['gitrob']['signatures'] = [
          {
            part: 'filename',
            type: 'match',
            pattern: 'c99.php',
            caption: 'Oh F*ck** backdoor!',
            description: nil,
          },
        ]
      end.converge(described_recipe)
    end

    it 'creates template[/root/.gitrobsignatures]' do
      config_file = '/root/.gitrobsignatures'
      expect(subject).to create_file(config_file)
        .with(owner: 'root',
              group: 'root')

      [/"part":"filename"/,
       /"type":"match"/,
       /"pattern":"c99.php"/,
       /"caption":"Oh F\*ck\*\* backdoor\!"/,
       /"description":null/].each do |m|
        expect(subject).to render_file(config_file).with_content(m)
      end
    end
  end
end
